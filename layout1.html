<!DOCTYPE html>
<html lang="en">
<head>
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta charset="utf-8">
    <title>Redington - Flightplan</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <link href="css/styles.css" rel="stylesheet">

    <link href="css/bootstrap.css" rel="stylesheet">
    <link href="css/controlfrog.css" rel="stylesheet" media="screen">
	<link href="favicon.ico" rel="shortcut icon" type="image/x-icon" />

	<script src="//code.jquery.com/jquery-1.9.1.min.js"></script>    
	<script src="js/moment.js"></script>	
	<script src="js/easypiechart.js"></script>
	<script src="js/gauge.js"></script>	
	<script src="js/chart.js"></script>
	<script src="js/jquery.sparklines.js"></script>			
    <script src="js/bootstrap.js"></script>
    <script src="js/controlfrog-plugins.js"></script>

    <script src="js/shake.js"></script>

    <!-- slider -->
    <link href="slider/css/slider.css" rel="stylesheet" />
    <script src="slider/js/bootstrap-slider.js"></script>
    <script src="js/modernizr-dev.js"></script>

    <!--[if lt IE 9]>
		<script src="js/respond.min.js"></script>
		<script src="js/excanvas.min.js"></script>
	<![endif]-->
    
    
	<script>
		var themeColour = 'white';
	</script>
    <script src="js/controlfrog.js"></script>
</head>
<body class="white maincontent">

    <div class="container-fluid header-bar">
        <div>
            <h3>Redington <i class="glyphicon glyphicon-chevron-right"></i> Interactive Flight Plan</h3>
        </div>
        <div class="reset-flight-plan pull-right" data-bind="click: reset">
            <span><i class="glyphicon glyphicon-repeat"></i> Reset</span>
        </div>
    </div>

    <div class="cf-container cf-nav-active">
        <div class="row" id="topRowContent"><!-- Top row -->
            <div class="col-sm-6 col-sm-push-6 cf-item">
                <!-- top left -->
                <div class="inner">
                    <header>
                        <p><span></span>Control Panel</p>
                    </header>
                    <div class="content">
                        <div class="panel">
                            <div class="panel-body">
                                <div class="asset-group">
                                    <div class="asset-group-header">
                                        <span>Physical Assets</span>
                                    </div>
                                    <div class="asset-group-body">
                                        <div class="asset-group-item row">
                                            <div class="col-xs-2">Equities</div>
                                            <div class="col-xs-9">
                                                <input type="text" data-bind="sliderValue: { value: controlPanel.controlPanelModel.equities, step: 10, max: 100 }" />
                                            </div>
                                            <div class="col-xs-1">
                                                <span data-bind="animateText: controlPanel.controlPanelModel.equities"></span>
                                            </div>
                                        </div>
                                        <div class="asset-group-item row">
                                            <div class="col-xs-2">Gilts</div>
                                            <div class="col-xs-9">
                                                <input type="text" data-bind="sliderValue: { value: controlPanel.controlPanelModel.gilts, step: 10, max: 100 }" />
                                            </div>
                                            <div class="col-xs-1">
                                                <span data-bind="animateText: controlPanel.controlPanelModel.gilts"></span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="asset-group">
                                    <div class="asset-group-header">
                                        <span>Synthetic Assets</span>
                                    </div>
                                    <div class="asset-group-body">
                                        <div class="asset-group-item row">
                                            <div class="col-xs-2">Swaps</div>
                                            <div class="col-xs-9">
                                                <input type="text" data-bind="sliderValue: { value: controlPanel.controlPanelModel.swaps, step: 10, max: 100 }" />
                                            </div>
                                            <div class="col-xs-1">
                                                <span data-bind="animateText: controlPanel.controlPanelModel.swaps"></span>
                                            </div>
                                        </div>
                                        <div class="asset-group-item row">
                                            <div class="col-xs-2">Vol Controlled Equities</div>
                                            <div class="col-xs-9">
                                                <input type="text" data-bind="sliderValue: { value: controlPanel.controlPanelModel.volControlledEquities, step: 10, max: 100 }" />
                                            </div>
                                            <div class="col-xs-1">
                                                <span data-bind="animateText: controlPanel.controlPanelModel.volControlledEquities"></span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="asset-group">
                                    <div class="asset-group-header">
                                        <span>Total</span>
                                    </div>
                                    <div class="asset-group-body">
                                        <div class="asset-group-item row">
                                            <div class="col-xs-11"></div>
                                            <div class="col-xs-1">
                                                <span class="asset-total-sum" data-bind="animateText: controlPanel.controlPanelModel.totalAssets"></span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div> <!-- //end inner -->
            </div>

            <div class="col-sm-6 col-sm-pull-6 cf-item">
                <!-- top right -->
                <div class="inner">
                    <header>
                        <p><span></span>PRMF</p>
                    </header>

                    <div class="content">

                        <table class="table table-hover table-prmf table-borderless-first-row">

                            <tr>
                                <th class="cf-txts-txt" data-bind="css: prmf().fptmpl">Flight Plan</th>
                                <td class="prmf-value" data-bind="css: prmf().fptmpl">
                                    Required Return: <span data-bind="animateText: prmf().required"></span><br/>
                                    Expected Return: <span data-bind="animateText: prmf().expected"></span>
                                </td>
                                <td class="cf-bars-bar  mb prmf-status">

                                    <!-- ko template: prmf().fptmpl -->
                                    <!-- /ko -->

                                </td>
                            </tr>

                            <tr>
                                <th class="cf-txts-txt"  data-bind="css: prmf().rbtmpl">Risk Budget</th>
                                <td class="prmf-value"  data-bind="css: prmf().rbtmpl">
                                    <span data-bind="animateText: prmf().risk"></span><br/>
                                    <span data-bind="animateText: prmf().targetrisk"></span>
                                </td>
                                <td class="cf-bars-bar mb prmf-status">
                                    <!-- ko template: prmf().rbtmpl -->
                                    <!-- /ko -->
                                </td>
                            </tr>

                            <tr>
                                <th class="cf-txts-txt"  data-bind="css: prmf().hrtmpl">Hedge Ratio</th>
                                <td class="prmf-value"  data-bind="css: prmf().hrtmpl">
                                    Hedge Ratio: <span data-bind="animateText: prmf().hedge"></span><br/>
                                    Funding Ratio: <span data-bind="animateText: prmf().fr"></span>
                                </td>
                                <td class="cf-bars-bar mb prmf-status">

                                    <!-- ko template: prmf().hrtmpl -->
                                    <!-- /ko -->

                                </td>
                            </tr>


                            <tr>
                                <th class="cf-txts-txt"  data-bind="css: prmf().cttmpl">Collateral</th>
                                <td class="prmf-value"  data-bind="css: prmf().cttmpl">
                                    <span data-bind="animateText: prmf().collateral"></span>
                                </td>
                                <td class="cf-bars-bar  mb prmf-status">

                                    <!-- ko template: prmf().cttmpl -->
                                    <!-- /ko -->

                                </td>
                            </tr>
                        </table>
                    </div>

                </div> <!-- //end inner -->

            </div>

        </div>
        <div class="row"><!-- Bottom row -->

            <div class="col-sm-6 cf-item">
                <!-- bottom left -->
                <div class="inner">
                    <header>
                            <p><span></span>Risk</p>
                    </header>
                    <div class="content">
                        <div class="new-settings-box">
                            <div id="new-risk-settings-toggle" class="container-fluid new-settings-box-content">
                                <div id="new-risk-settings-collapsible" class="row collapse in">
                                    <div class="new-settings-box-item">
                                        <span>Basis Risk:</span>
                                        <div class="btn-group btn-group-xs" data-toggle="buttons">
                                            <button type="button" class="btn btn-info" data-bind="click: risk.riskModel.includeBasisRisk, css: { active: risk.riskModel.basisRisk() === true }">On</button>
                                            <button type="button" class="btn btn-info" data-bind="click: risk.riskModel.excludeBasisRisk, css: { active: risk.riskModel.basisRisk() === false }">Off</button>
                                        </div>
                                    </div>
                                    <div class="new-settings-box-item">
                                        <span>Risk:</span>
                                        <div class="btn-group btn-group-xs" data-toggle="buttons">
                                            <label class="btn btn-info">
                                                <input type="radio" name="RAR" value="FRAR" data-bind="bsChecked: risk.riskModel.riskLens" /> FRAR
                                            </label>
                                            <label class="btn btn-info">
                                                <input type="radio" name="RAR" value="RAR" data-bind="bsChecked: risk.riskModel.riskLens" /> RAR
                                            </label>
                                            <label class="btn btn-info">
                                                <input type="radio" name="RAR" value="VAR" data-bind="bsChecked: risk.riskModel.riskLens" /> VAR
                                            </label>
                                            <label class="btn btn-info">
                                                <input type="radio" name="RAR" value="CAR" data-bind="bsChecked: risk.riskModel.riskLens" /> CAR
                                            </label>
                                        </div>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="new-settings-toggle">
                                        <span class="settings-helper-text"><i class="glyphicon glyphicon-cog"></i> &nbsp;&nbsp;click to change settings</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="panel">
                            <div id="riskChart"></div>
                        </div>
                        <!--<div class="risk-settings-box active">-->
                            <!--<div class="risk-settings-box-toggle">-->
                                <!--<i class="glyphicon glyphicon-cog"></i>-->
                            <!--</div>-->
                            <!--<div class="settings-box-content">-->
                                <!--<div class="settings-box-item">-->
                                    <!--<span>Basis risk:</span>-->
                                    <!--<div class="btn-group btn-group-xs" data-toggle="buttons">-->
                                        <!--<button type="button" class="btn btn-info" data-bind="click: risk.riskModel.includeBasisRisk, css: { active: risk.riskModel.basisRisk() === true }">On</button>-->
                                        <!--<button type="button" class="btn btn-info" data-bind="click: risk.riskModel.excludeBasisRisk, css: { active: risk.riskModel.basisRisk() === false }">Off</button>-->
                                    <!--</div>-->
                                <!--</div>-->
                                <!--<div class="settings-box-item">-->
                                    <!--<div class="radio">-->
                                        <!--<label>-->
                                            <!--<input type="radio" name="riskSetting2" checked>-->
                                            <!--fRAR-->
                                        <!--</label>-->
                                    <!--</div>-->
                                    <!--<div class="radio">-->
                                        <!--<label>-->
                                            <!--<input type="radio" name="riskSetting2">-->
                                            <!--RAR-->
                                        <!--</label>-->
                                    <!--</div>-->
                                    <!--<div class="radio">-->
                                        <!--<label>-->
                                            <!--<input type="radio" name="riskSetting2">-->
                                            <!--VAR-->
                                        <!--</label>-->
                                    <!--</div>-->
                                    <!--<div class="radio">-->
                                        <!--<label>-->
                                            <!--<input type="radio" name="riskSetting2">-->
                                            <!--CAR-->
                                        <!--</label>-->
                                    <!--</div>-->
                                <!--</div>-->
                            <!--</div>-->
                        <!--</div>-->
                    </div>
                </div> <!-- //end inner -->
            </div>

            <div class="col-sm-6 cf-item">
                <!-- bottom right -->
                <div class="inner">
                    <header>
                        <p><span></span>Flight Plan</p>
                    </header>
                    <div class="content">
                        <div class="new-settings-box">
                            <div id="new-flightplan-settings-toggle" class="container-fluid new-settings-box-content">
                                <div id="new-flightplan-settings-collapsible" class="row collapse in">
                                    <div class="new-settings-box-item">
                                        <span>Target funding year:</span>
                                        <select class="form-control" data-bind="options: flightPlan.flightPlanModel.targetFundingYears, value: flightPlan.flightPlanModel.targetFundingYear"></select>
                                    </div>
                                    <div class="new-settings-box-item">
                                        <span>Contributions:</span>
                                        <select class="form-control">
                                            <option>£60m (-40%)</option>
                                            <option>£70m (-30%)</option>
                                            <option>£80m (-20%)</option>
                                            <option>£90m (-10%)</option>
                                            <option selected>£100m</option>
                                            <option>£110m (+10%)</option>
                                            <option>£120m (+20%)</option>
                                            <option>£130m (+30%)</option>
                                            <option>£140m (+40%)</option>
                                        </select>
                                    </div>
                                    <div class="new-settings-box-item">
                                        <span>Discount Basis:</span>
                                        <div>
                                            <div class="radio">
                                                <input type="radio" name="flightplanBasis" value="TechnicalProvision" data-bind="checked: flightPlan.flightPlanModel.discountBasis" />
                                                Technical Provision
                                            </div>
                                            <div class="radio">
                                                <input type="radio" name="flightplanBasis" value="SelfSufficiency" data-bind="checked: flightPlan.flightPlanModel.discountBasis" />
                                                Self Sufficiency
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="new-settings-toggle">
                                        <span class="settings-helper-text"><i class="glyphicon glyphicon-cog"></i> &nbsp;&nbsp;click to change settings</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="panel">
                            <div id="flightPlanChart" style="height: 400px;"></div>
                        </div>
                        <!--<div class="flightplan-settings-box active">-->
                            <!--<div class="flightplan-settings-box-toggle">-->
                                <!--<i class="glyphicon glyphicon-cog"></i>-->
                            <!--</div>-->
                            <!--<div class="settings-box-content">-->
                                <!--<div class="settings-box-item">-->
                                    <!--<span>Target funding year:</span> <select class="form-control" data-bind="options: flightPlan.flightPlanModel.targetFundingYears, value: flightPlan.flightPlanModel.targetFundingYear"></select>-->
                                <!--</div>-->
                                <!--<div class="settings-box-item">-->
                                    <!--<span>Contributions:</span>-->
                                    <!--<select class="form-control">-->
                                        <!--<option>£60m (-40%)</option>-->
                                        <!--<option>£70m (-30%)</option>-->
                                        <!--<option>£80m (-20%)</option>-->
                                        <!--<option>£90m (-10%)</option>-->
                                        <!--<option selected>£100m</option>-->
                                        <!--<option>£110m (+10%)</option>-->
                                        <!--<option>£120m (+20%)</option>-->
                                        <!--<option>£130m (+30%)</option>-->
                                        <!--<option>£140m (+40%)</option>-->
                                    <!--</select>-->
                                <!--</div>-->
                                <!--<div class="settings-box-item">-->
                                    <!--<span>Discount Basis:</span>-->
                                    <!--<div class="radio nottoggle">-->
                                        <!--<label>-->
                                            <!--<input type="radio" name="flightplanBasis" checked>-->
                                            <!--Technical Provision-->
                                        <!--</label>-->
                                    <!--</div>-->
                                    <!--<div class="radio">-->
                                        <!--<label>-->
                                            <!--<input type="radio" name="flightplanBasis">-->
                                            <!--Self Sufficiency-->
                                        <!--</label>-->
                                    <!--</div>-->
                                <!--</div>-->
                            <!--</div>-->
                        <!--</div>-->
                    </div>
                </div> <!-- //end inner -->
            </div>

        </div>
        <div class="modal fade" id="riskChartData" tabindex="-1" role="dialog" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-body">
                        <table class="table table-hover table-striped">
                            <tbody data-bind="foreach: risk.riskModel.chartDataItems">
                                <tr>
                                    <td>
                                        <span data-bind="text: riskName "></span>
                                    </td>
                                    <td>
                                        <span data-bind="text: riskPercentage "></span>%
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>


    <!-- knockout templates -->

    <script type="text/html" id="m-red">
        <span class="glyphicon glyphicon-exclamation-sign prmf-icon m-red"></span>
    </script>

    <script type="text/html" id="m-amber">
        <span class="glyphicon glyphicon-minus-sign prmf-icon m-amber"></span>
    </script>

    <script type="text/html" id="m-green">
        <span class="glyphicon glyphicon-ok-sign prmf-icon m-green"></span>
    </script>


    <script src="js/underscore.js"></script>
    <script src="js/highcharts.js"></script>
    <script src="js/highcharts-more.js"></script>
    <script src="js/highcharts-customevents.js"></script>

    <script src="js/knockout-min.js"></script>
    <script src="js/app/services/chartHelper.js"></script>

    <script>

    function hideAllCollapsibles() {
        $('.collapse').collapse('hide');
    }

    function modalRiskChartData() {
        $('#riskChartData').modal();
    }

    $(function (){
       //attach  click handler to collapsible settings panels
       $('#new-flightplan-settings-toggle').on('click', function (e) {
           if ($(e.target).is('select, input, button, label, a')){
               return;
           }
           $('#new-flightplan-settings-collapsible').collapse('toggle');
       });

        $('#new-risk-settings-toggle').on('click', function (e) {
            if ($(e.target).is('select, input, button, label, a')){
                return;
            }
            $('#new-risk-settings-collapsible').collapse('toggle');
        });

        //hide the settings panels
        $('#new-risk-settings-collapsible').collapse('hide');
        $('#new-flightplan-settings-collapsible').collapse('hide');

        $('#topRowContent').on('click', hideAllCollapsibles);
    });

//    $(function () {
//        $('.flightplan-settings-box').animate({
//            right: "-229px"
//        }, 'slow').removeClass('active');
//
//        $('.flightplan-settings-box-toggle').on('click', function () {
//            if ($('.flightplan-settings-box').hasClass('active')){
//                $('.flightplan-settings-box').animate({
//                    right: '-229px'
//                }, 'slow').removeClass('active')
//            }else{
//                $('.flightplan-settings-box').animate({
//                    right: '-29px'
//                }, 'slow').addClass('active')
//            }
//        })
//    });
//
//    $(function () {
//        $('.risk-settings-box').animate({
//            left: '-229px'
//        }, 'slow').removeClass('active');
//
//        $('.risk-settings-box-toggle').on('click', function () {
//            if ($('.risk-settings-box').hasClass('active')){
//                $('.risk-settings-box').animate({
//                    left: '-229px'
//                }, 'slow').removeClass('active')
//            }else{
//                $('.risk-settings-box').animate({
//                    left: '-29px'
//                }, 'slow').addClass('active')
//            }
//        })
//    });

        ko.bindingHandlers.sliderValue = {
            init: function (element, valueAccessor, allBindings, viewModel, bindingContext) {
                var params = valueAccessor();

                //ensure valueAccessor is either an observable item or contains a 'value' item
                if (!(ko.isObservable(params) || params['value'] !== undefined)){
                    throw "You need to define an observable value for the sliderValue. Either pass the observable directly or in the 'value' field in the parameters";
                }

                var valueObservable;
                if (ko.isObservable(params)){       //if observable, create slider using params directly
                    valueObservable = params;
                    $(element).slider({value: ko.unwrap(params)});
                }else{                              //otherwise, replace params['value'] with the actual value and create slider using set of parameters
                    valueObservable = params['value'];
                    params['value'] = ko.unwrap(valueObservable);
                    $(element).slider(params);
                }

                $(element).on('slideStop', function (ev) {
                    if (ko.isObservable(valueObservable)) valueObservable(ev.value);
                });
            },
            update: function (element, valueAccessor, allBindings, viewModel, bindingContext) {
                var modelValue = valueAccessor();
                var valueObservable;
                if (ko.isObservable(modelValue)){
                    valueObservable = modelValue;
                }else{
                    valueObservable = modelValue['value'];
                }

                $(element).slider('setValue', ko.unwrap(valueObservable));
            }
        };

    ko.bindingHandlers['animateText'] = {
        'update': function (element, valueAccessor) {
            $(element).hide();
            ko.bindingHandlers.text.update(element, valueAccessor);
            $(element).fadeIn('slow');
        }
    };

    ko.bindingHandlers.bsChecked = {
        init: function (element, valueAccessor, allBindingsAccessor,
                        viewModel, bindingContext) {
            var value = valueAccessor();
            var newValueAccessor = function () {
                return {
                    change: function () {
                        value(element.value);
                    }
                }
            };
            ko.bindingHandlers.event.init(element, newValueAccessor,
                    allBindingsAccessor, viewModel, bindingContext);
        },
        update: function (element, valueAccessor, allBindingsAccessor,
                          viewModel, bindingContext) {
            if ($(element).val() == ko.unwrap(valueAccessor())) {
                $(element).closest('.btn').button('toggle');
            }
        }
    }

        var fp = fp || {};

        fp.RiskModel = function (dependencies) {
            var self = this;
            var renderedChart;
            var yAxisMinRange = 0;
            var yAxisMinRangeSet = false;

            var hideCollapsibleFunction;
            var showDataFunction;

            var numberAssetRisks = 0;
            var numberLiabilityRisks = 0;
            var numberBasisRisks = 0;
            var numberRisksSet = false;

            if (!dependencies) dependencies = {};

            self.colours = ["#bdea74", "#eae874", "#2FABE9", "#FA5833"];
            self.chartData = ko.observableArray([]);
            self.riskTableOriginal = ko.observableArray([]);
            self.chartYAxisTitle = ko.observable('Percentage of Total Liabilities');
            self.basisRisk = ko.observable(true);
            self.riskLens = ko.observable('FRAR');

            self.options = {
                skip: 1,
                decimalPlaces: 2,
                drilldown: 'byName',
                drilldownColumnIndex: 1,
                na: '-'
            };

            self.includeBasisRisk = function(){
              self.basisRisk(true);
            };

            self.excludeBasisRisk = function(){
                self.basisRisk(false);
            };

            self.chartWrapper = dependencies.chartWrapper || new irisHighChartWrapper();
            hideCollapsibleFunction = dependencies.hideCollapsibleFunction;
            showDataFunction = dependencies.showDataFunction;

            self.reset = function () {
                //reset basis risk to true
                self.basisRisk(true);
                renderedChart = undefined;
            };

            var riskTypeColor = function(riskType) {
                switch (riskType){
                    case 'Asset Risk':
                        return '#CA2F2F';
                    case 'Liability Risk':
                        return '#3FAEF8';
                    case 'Basis Risk':
                        return '#E9D65A';
                    case 'Diversification':
                        return '#858B8C';
                    case 'Total':
                        return '#158141';
                }
            };

            var incrementRiskTypeCounters = function(riskType) {
                switch (riskType){
                    case 'Asset Risk':
                        numberAssetRisks += 1;
                    case 'Liability Risk':
                        numberLiabilityRisks += 1;
                    case 'Basis Risk':
                        numberBasisRisks += 1;
                };
            };

            self.waterfallData = ko.computed(function () {
                //var colours = ["#D94542", "#578BCA", "#819E43", "#B0C9F5", "#9EDAEB"];
                var colourIndex = -1;
                var currentCategory = "";
                var result = [];
                if (self.chartData().length === 0) return result;

                var stringData = ko.utils.stringifyJson(self.chartData());
                var copyOfOriginalData = JSON.parse(stringData);
                copyOfOriginalData.shift();

                var diversificationFound = false;

                ko.utils.arrayForEach(copyOfOriginalData, function (data) {
                    data.shift();

                    var pushData = true;
                    //do not push data if basisRisk is false and data in current iteration is Basis Risk related
                    if (self.basisRisk() === false && (data[0] === 'Interest Rate Basis Risk' || data[0] === 'Inflation Basis Risk')){
                        pushData = false;
                    }

                    if (data[0] !== null && diversificationFound === false && pushData) {

                        if (data[5] !== currentCategory) {
                            colourIndex += 1;
                            currentCategory = data[5];
                        }
                        var seriesColour = riskTypeColor(data[5]);
                        if (!numberRisksSet) incrementRiskTypeCounters(data[5]);

                        var y;
                        switch (self.riskLens()){           // load data from column based on risk lens
                            case 'FRAR':
                                y = parseFloat(data[1]);
                                break;
                            case 'RAR':
                                y = parseFloat(data[2]);
                                break;
                            case 'VAR':
                                y = parseFloat(data[3]);
                                break;
                            case 'CAR':
                                y = parseFloat(data[4]);
                                break;
                        };

                        y *= 100;
                        if (data[0] === "Diversification") {
                            diversificationFound = true;
                            var y1 = parseFloat(y.toFixed(1)) - (parseFloat(y.toFixed(2)) * 2);
                            //result.push({ name: data[0], y: y1, color: colours[colourIndex] });
                            result.push({ name: data[0], y: y1, color: seriesColour });
                        } else {
                            //result.push({ name: data[0], y: parseFloat(y.toFixed(2)), color: colours[colourIndex] });
                            result.push({ name: data[0], y: parseFloat(y.toFixed(2)), color: seriesColour });
                            if (!yAxisMinRangeSet) yAxisMinRange += parseFloat(y.toFixed(2));
                        }
                    }
                });

                numberRisksSet = true;

                //result.push({ name: 'Total', y: 0, color: colours[colourIndex += 1] });
                result.push({ name: 'Total', y: 0 });

                return result;
            });

            self.totalSeriesData = ko.computed(function () {
                var result = [];
                if (self.chartData().length === 0) return result;

                var stringData = ko.utils.stringifyJson(self.chartData());
                var copyOfOriginalData = JSON.parse(stringData);
                copyOfOriginalData.shift();

                ko.utils.arrayForEach(copyOfOriginalData, function (data) {
                    data.shift();

                    var pushData = true;
                    //do not push data if basisRisk is false and data in current iteration is Basis Risk related
                    if (self.basisRisk() === false && (data[0] === 'Interest Rate Basis Risk' || data[0] === 'Inflation Basis Risk')){
                        pushData = false;
                    }
                    if (pushData) {
                        if (data[0] !== "Total" && data[0] !== null) {
                            result.push({ y: 0 });
                        } else if (data[0] === "Total") {
                            var seriesColour = riskTypeColor(data[5]);

                            var y;
                            switch (self.riskLens()){           // load data from column based on risk lens
                                case 'FRAR':
                                    y = parseFloat(data[1]);
                                    break;
                                case 'RAR':
                                    y = parseFloat(data[2]);
                                    break;
                                case 'VAR':
                                    y = parseFloat(data[3]);
                                    break;
                                case 'CAR':
                                    y = parseFloat(data[4]);
                                    break;
                            };

                            y *= 100;
                            result.push({ y: y, color: seriesColour });
                        }
                    }
                });

                return result;
            });

            self.displayChart = ko.computed(function () {
                if (self.waterfallData().length === 0) return;
                if (self.totalSeriesData().length === 0) return;

                if (renderedChart === undefined){
                    var options = {
                        chartId: "#riskChart",
                        waterFallData: self.waterfallData(),
                        independantData: self.totalSeriesData(),
                        yAxisTitle: self.chartYAxisTitle(),
                        xAxisTitle: "Risk Type",
                        xAxisRotation: -45,
                        xAxisLabelEvents: {
                            dblclick: showDataFunction
                        },
                        xAxisPlotBands: [
                            {
                                color: '#F5E6DF',
                                from: -0.5,
                                to: numberAssetRisks - 0.5
                            },
                            {
                                color: '#DDF1F8',
                                from: numberAssetRisks - 0.5,
                                to: numberLiabilityRisks - 0.5
                            }
                        ],
                        yAxisMin: 0,
                        yAxisMinRange: yAxisMinRange,
                        dataLabels: true,
                        chartEvents: {
                              click: hideCollapsibleFunction
                        }
                    };
                    yAxisMinRangeSet = true;
                    renderedChart = self.chartWrapper.displayWaterfallChart(options);
                }else{
                    renderedChart.series[0].setData(self.waterfallData());
                    renderedChart.series[1].setData(self.totalSeriesData());
                }
            });

            self.chartDataItems = ko.computed(function() {
                var result = [];
                if (self.chartData().length === 0) return result;

                var stringData = ko.utils.stringifyJson(self.chartData());
                var copyOfOriginalData = JSON.parse(stringData);
                copyOfOriginalData.shift();

                ko.utils.arrayForEach(copyOfOriginalData, function (data) {
                    data.shift();
                    var y = parseFloat(data[1]);
                    y *= 100;
                    result.push({ riskName: data[0], riskPercentage: parseFloat(y.toFixed(2)) });
                });

                return result;

            })
        };

        fp.FlightPlanModel = function (dependencies) {
            var self = this;

            var startTargetFundingYear = 2030;
            var hideCollapsibleFunction;

            if (!dependencies) dependencies = {};
            hideCollapsibleFunction = dependencies.hideCollapsibleFunction;
            self.chartWrapper = dependencies.chartWrapper || new irisHighChartWrapper();
            self.chartData = ko.observableArray([]);
            self.targetFundingYear = ko.observable(startTargetFundingYear);
            self.targetFundingYears = ko.observableArray([2024,2025,2026,2027,2028,2029,2030]);

            self.discountBasis = ko.observable('SelfSufficiency');

            var seriesData = [
                { name: 'Liabilities', color: '#2FABE9', data: [], index: 2 },
                { name: 'Required Return', color: '#FA5833', data: [], index: 1 },
                { name: 'Expected Return', color: '#008000', data: [], dashStyle: 'shortdash', index: 0 }
            ];

            var options = {
                renderTo: '#flightPlanChart',
                lineSeriesData: seriesData,
                yAxisTitle: "GBP Millions",
                xAxisTitle: "Date",
                dataLabels: true,
                chartEvents: {
                    click: function(event) {
                        if (hideCollapsibleFunction) hideCollapsibleFunction();
                    }
                }
            };

            var renderedChart;

            var inMillions = function (num) {
                var result = Math.round(num / 1000000);
                return result;
            };

            self.displayChart = ko.computed(function () {
                if (self.chartData().length === 0) return;

                seriesData[0].data = [];
                seriesData[1].data = [];
                seriesData[2].data = [];
                ko.utils.arrayForEach(self.chartData(), function (item, i) {
                    if (item[0] !== 'Date') {   //ignore if first item in array is 'Date' (this is the header)
                        var stamp = moment.utc(item[0]);
                        if (stamp != undefined){
                            var rr = [stamp.unix() * 1000 + 1000, inMillions(parseInt(item[1]))];
                            var l = [stamp.unix() * 1000 + 1000, inMillions(parseInt(item[2]))];
                            var er = [stamp.unix() * 1000 + 1000, inMillions(parseInt(item[3]))];

                            seriesData[0].data.push(l);
                            seriesData[1].data.push(rr);
                            seriesData[2].data.push(er);
                        }
                    }
                });

                if (renderedChart === undefined){
                    renderedChart = self.chartWrapper.displayFlightPlanLineChart(options);
                }else{
                    renderedChart.series[0].setData(seriesData[2].data);
                    renderedChart.series[1].setData(seriesData[1].data);
                    renderedChart.series[2].setData(seriesData[0].data);
                }
            });

            self.addOneToTargetFundingYear = function () {
                self.targetFundingYear(self.targetFundingYear() + 1);
            };

            self.subtractOneFromTargetFundingYear = function () {
                self.targetFundingYear(self.targetFundingYear() - 1);
            };

            self.targetFundingYear.subscribe(function (newValue) {
                changeTargetFundingYear(newValue);
            });

            var changeTargetFundingYear = function (newValue) {

                var newData = [];
                var brentsConstant = 0.003;
                var newDataItem = 0;

                ko.utils.arrayForEach(self.chartData(), function (item, i) {
                    if (item[0] !== 'Date') {
                        var stamp = moment.utc(item[0]);
                        var baseRR = inMillions(parseInt(item[1]));
                        var l = inMillions(parseInt(item[2]));
                        newDataItem = baseRR + Math.floor(baseRR * (startTargetFundingYear - newValue) * i * brentsConstant);

                        if (newDataItem > l) {
                            newDataItem = l;
                        }

                        var nd = [stamp.unix() * 1000 + 1000, newDataItem];
                        newData.push(nd)
                    }
                });

                renderedChart.series[1].setData(newData);
            }
        };

    fp.ControlPanelModel = function(dependencies) {
        var self = this;
        if (!dependencies) dependencies = {};

        self.equities = ko.observable(dependencies.startingEquities);
        self.gilts = ko.observable(dependencies.startingGilts);
        self.swaps = ko.observable(dependencies.startingSwaps);
        self.volControlledEquities = ko.observable(dependencies.startingVolControlledEquities);
        self.totalAssets = ko.computed(function () {
            return self.equities() + self.gilts() + self.swaps() + self.volControlledEquities();
        });

        self.equities.subscribe(dependencies.assetAllocationChangedCallback);
        self.gilts.subscribe(dependencies.assetAllocationChangedCallback);
        self.swaps.subscribe(dependencies.assetAllocationChangedCallback);
        self.volControlledEquities.subscribe(dependencies.assetAllocationChangedCallback);

        self.reset = function () {
            self.equities(dependencies.startingEquities);
            self.gilts(dependencies.startingGilts);
            self.swaps(dependencies.startingSwaps);
            self.volControlledEquities(dependencies.startingVolControlledEquities);
        }
    };

        fp.prmf = [
            {
                required : "100 bps",
                expected : "210 bps",
                risk : "FRAR 18%",
                targetrisk : "Target 12%",
                hedge : "25%",
                fr : "70%",
                collateral : "£300M",
                fptitle : "Flight Plan",
                rbtitle : "Risk Budget",
                hrtitle : "Hedge Ratio",
                cttitle : "Collateral",
                fptmpl : "m-green",
                rbtmpl : "m-red",
                hrtmpl : "m-red",
                cttmpl : "m-green"
            },
            {
                required : "100 bps",
                expected : "210 bps",
                risk : "FRAR 13%",
                targetrisk : "Target 12%",
                hedge : "50%",
                fr : "70%",
                collateral : "£50M",
                fptitle : "Flight Plan",
                rbtitle : "Risk Budget",
                hrtitle : "Hedge Ratio",
                cttitle : "Collateral",
                fptmpl : "m-green",
                rbtmpl : "m-amber",
                hrtmpl : "m-red",
                cttmpl : "m-green"
            },
            {
                required : "100 bps",
                expected : "180 bps",
                risk : "FRAR 8%",
                targetrisk : "Target 12%",
                hedge : "60%",
                fr : "70%",
                collateral : "£150M",
                fptitle : "Flight Plan",
                rbtitle : "Risk Budget",
                hrtitle : "Hedge Ratio",
                cttitle : "Collateral",
                fptmpl : "m-green",
                rbtmpl : "m-green",
                hrtmpl : "m-amber",
                cttmpl : "m-green"
            },
            {
                required : "100 bps",
                expected : "0 bps",
                risk : "FRAR 5%",
                targetrisk : "Target 12%",
                hedge : "50%",
                fr : "70%",
                collateral : "£50M",
                fptitle : "Flight Plan",
                rbtitle : "Risk Budget",
                hrtitle : "Hedge Ratio",
                cttitle : "Collateral",
                fptmpl : "m-red",
                rbtmpl : "m-amber",
                hrtmpl : "m-red",
                cttmpl : "m-green"
            },
            {
                required : "100 bps",
                expected : "0 bps",
                risk : "FRAR 5%",
                targetrisk : "Target 12%",
                hedge : "50%",
                fr : "70%",
                collateral : "£50M",
                fptitle : "Flight Plan",
                rbtitle : "Risk Budget",
                hrtitle : "Hedge Ratio",
                cttitle : "Collateral",
                fptmpl : "m-red",
                rbtmpl : "m-amber",
                hrtmpl : "m-red",
                cttmpl : "m-green"
            }
        ];

        fp.controlPanelData = [
            {
                equities: 70,
                gilts: 30,
                swaps: 0,
                volControlledEquities: 0
            },
            {
                equities: 70,
                gilts: 30,
                swaps: 30,
                volControlledEquities: 0
            },
            {
                equities: 0,
                gilts: 40,
                swaps: 30,
                volControlledEquities: 60
            },
            {
                equities: 0,
                gilts: 30,
                swaps: 30,
                volControlledEquities: 0
            },
            {
                equities: 0,
                gilts: 40,
                swaps: 30,
                volControlledEquities: 0
            }
        ];

        fp.riskData = [[
            ["Date", "Risk Type", "Percentage of Total Liabilities", "RAR", "VAR", "CAR", "Category",  null],
            ["31 January 2014", "Equity Risk", "0.07212", "0.068514", "0.064908", "0.061302", "Asset Risk",  null],
            ["32 January 2014", "Alternative Risk", "0", "0", "0", "0", "Asset Risk",  null],
            ["33 January 2014", "FX Risk", "0", "0", "0", "0", "Asset Risk",  null],
            ["34 January 2014", "Credit Risk", "0", "0", "0", "0", "Asset Risk",  null],
            ["35 January 2014", "Insurance Risk", "0", "0", "0", "0", "Asset Risk",  null],
            ["36 January 2014", "Interest Rate Risk", "0.10238", "0.097261", "0.092142", "0.087023", "Liability Risk",  null],
            ["37 January 2014", "Inflation Risk", "0.050321", "0.04780495", "0.0452889", "0.04277285", "Liability Risk",  null],
            ["38 January 2014", "Interest Rate Basis Risk", "0", "0", "0", "0", "Basis Risk",  null],
            ["39 January 2014", "Inflation Basis Risk", "0", "0", "0", "0", "Basis Risk",  null],
            ["40 January 2014", "Diversification", "0.040021", "0.03801995", "0.0360189", "0.03401785", "Diversification",  null],
            ["41 January 2014", "Total", "0.1802", "0.17119", "0.16218", "0.15317", "Total",  null]
        ],[
            ["Date", "Risk Type", "Percentage of Total Liabilities", "RAR", "VAR", "CAR", "Category",  null],
            ["31 January 2014", "Equity Risk", "0.07212", "0.068514", "0.064908", "0.061302", "Asset Risk",  null],
            ["32 January 2014", "Alternative Risk", "0", "0", "0", "0", "Asset Risk",  null],
            ["33 January 2014", "FX Risk", "0", "0", "0", "0", "Asset Risk",  null],
            ["34 January 2014", "Credit Risk", "0", "0", "0", "0", "Asset Risk",  null],
            ["35 January 2014", "Insurance Risk", "0", "0", "0", "0", "Asset Risk",  null],
            ["36 January 2014", "Interest Rate Risk", "0.06121", "0.0581495", "0.055089", "0.0520285", "Liability Risk",  null],
            ["37 January 2014", "Inflation Risk", "0.0371", "0.035245", "0.03339", "0.031535", "Liability Risk",  null],
            ["38 January 2014", "Interest Rate Basis Risk", "0", "0", "0", "0", "Basis Risk",  null],
            ["39 January 2014", "Inflation Basis Risk", "0", "0", "0", "0", "Basis Risk",  null],
            ["40 January 2014", "Diversification", "0.047021", "0.04466995", "0.0423189", "0.03996785", "Diversification",  null],
            ["41 January 2014", "Total", "0.1204", "0.11438", "0.10836", "0.10234", "Total",  null]
        ],[
            ["Date", "Risk Type", "Percentage of Total Liabilities", "RAR", "VAR", "CAR", "Category",  null],
            ["31 January 2014", "Equity Risk", "0.04001", "0.0380095", "0.036009", "0.0340085", "Asset Risk",  null],
            ["32 January 2014", "Alternative Risk", "0", "0", "0", "0", "Asset Risk",  null],
            ["33 January 2014", "FX Risk", "0", "0", "0", "0", "Asset Risk",  null],
            ["34 January 2014", "Credit Risk", "0", "0", "0", "0", "Asset Risk",  null],
            ["35 January 2014", "Insurance Risk", "0", "0", "0", "0", "Asset Risk",  null],
            ["36 January 2014", "Interest Rate Risk", "0.04002", "0.038019", "0.036018", "0.034017", "Liability Risk",  null],
            ["37 January 2014", "Inflation Risk", "0.0271", "0.025745", "0.02439", "0.023035", "Liability Risk",  null],
            ["38 January 2014", "Interest Rate Basis Risk", "0", "0", "0", "0", "Basis Risk",  null],
            ["39 January 2014", "Inflation Basis Risk", "0", "0", "0", "0", "Basis Risk",  null],
            ["40 January 2014", "Diversification", "0.027021", "0.02566995", "0.0243189", "0.02296785", "Diversification",  null],
            ["41 January 2014", "Total", "0.0804", "0.07638", "0.07236", "0.06834", "Total",  null]
        ]];

        fp.flightPlanData = [[
            ["Date",  "GF Asset (Gilts +177bps)",  "GF Liability (Gilt flat)",  "GF Expected Asset (Gilts +177bps)",  null],
            ["28 June 2013",  "1419816589",  "1824449370", "1419816589",  null],
            ["30 September 2013",  "1416916182",  "1818554559", "1421166931",  null],
            ["30 June 2014",  "1412647751",  "1793890195", "1421136351",  null],
            ["30 June 2015",  "1417703004",  "1769838176", "1430500647",  null],
            ["30 June 2016",  "1429176417",  "1754250356", "1446403864",  null],
            ["30 June 2017",  "1453465547",  "1754488164", "1475398735",  null],
            ["30 June 2018",  "1482378990",  "1759952119", "1509262735",  null],
            ["30 June 2019",  "1513284499",  "1767020958", "1545350919",  null],
            ["30 June 2020",  "1542372293",  "1778332423", "1579780247",  null],
            ["30 June 2021",  "1578037371",  "1796684312", "1621159259",  null],
            ["30 June 2022",  "1619577242",  "1820908259", "1668825763",  null],
            ["30 June 2023",  "1659350486",  "1841652201", "1714937867",  null],
            ["30 June 2024",  "1682379988",  "1842430887", "1743955062",  null],
            ["30 June 2025",  "1699311422",  "1835617536", "1766790705",  null],
            ["30 June 2026",  "1715221123",  "1826781602", "1788682173",  null],
            ["30 June 2027",  "1732560717",  "1818281248", "1812184696",  null],
            ["30 June 2028",  "1749060877",  "1807627789",  "1807627789",  null],
            ["30 June 2029",  "1762273714",  "1792263917",  "1792263917",  null],
            ["30 June 2030",  "1774795214",  "1774795214",  "1774795214",  null]
        ],[
            ["Date",  "GF Asset (Gilts +177bps)",  "GF Liability (Gilt flat)",  "GF Expected Asset (Gilts +177bps)",  null],
            ["28 June 2013",  "1419816589",  "1824449370", "1419816589",  null],
            ["30 September 2013",  "1416916182",  "1818554559", "1421166931",  null],
            ["30 June 2014",  "1412647751",  "1793890195", "1421136351",  null],
            ["30 June 2015",  "1417703004",  "1769838176", "1430500647",  null],
            ["30 June 2016",  "1429176417",  "1754250356", "1446403864",  null],
            ["30 June 2017",  "1453465547",  "1754488164", "1475398735",  null],
            ["30 June 2018",  "1482378990",  "1759952119", "1509262735",  null],
            ["30 June 2019",  "1513284499",  "1767020958", "1545350919",  null],
            ["30 June 2020",  "1542372293",  "1778332423", "1579780247",  null],
            ["30 June 2021",  "1578037371",  "1796684312", "1621159259",  null],
            ["30 June 2022",  "1619577242",  "1820908259", "1668825763",  null],
            ["30 June 2023",  "1659350486",  "1841652201", "1714937867",  null],
            ["30 June 2024",  "1682379988",  "1842430887", "1743955062",  null],
            ["30 June 2025",  "1699311422",  "1835617536", "1766790705",  null],
            ["30 June 2026",  "1715221123",  "1826781602", "1788682173",  null],
            ["30 June 2027",  "1732560717",  "1818281248", "1812184696",  null],
            ["30 June 2028",  "1749060877",  "1807627789",  "1807627789",  null],
            ["30 June 2029",  "1762273714",  "1792263917",  "1792263917",  null],
            ["30 June 2030",  "1774795214",  "1774795214",  "1774795214",  null]
        ],[
            ["Date",  "GF Asset (Gilts +177bps)",  "GF Liability (Gilt flat)",  "GF Expected Asset (Gilts +177bps)",  null],
            ["28 June 2013",  "1419816589",  "1824449370", "1419816589",  null],
            ["30 September 2013",  "1416916182",  "1818554559", "1419750014",  null],
            ["30 June 2014",  "1412647751",  "1793890195", "1418303993",  null],
            ["30 June 2015",  "1417703004",  "1769838176", "1426226246",  null],
            ["30 June 2016",  "1429176417",  "1754250356", "1440644174",  null],
            ["30 June 2017",  "1453465547",  "1754488164", "1468058457",  null],
            ["30 June 2018",  "1482378990",  "1759952119", "1500256718",  null],
            ["30 June 2019",  "1513284499",  "1767020958", "1534598022",  null],
            ["30 June 2020",  "1542372293",  "1778332423", "1567223688",  null],
            ["30 June 2021",  "1578037371",  "1796684312", "1606670345",  null],
            ["30 June 2022",  "1619577242",  "1820908259", "1652261871",  null],
            ["30 June 2023",  "1659350486",  "1841652201", "1696223453",  null],
            ["30 June 2024",  "1682379988",  "1842430887", "1723204230",  null],
            ["30 June 2025",  "1699311422",  "1835617536", "1744027612",  null],
            ["30 June 2026",  "1715221123",  "1826781602", "1763876677",  null],
            ["30 June 2027",  "1732560717",  "1818281248", "1785271559",  null],
            ["30 June 2028",  "1749060877",  "1807627789",  "1807627789",  null],
            ["30 June 2029",  "1762273714",  "1792263917",  "1792263917",  null],
            ["30 June 2030",  "1774795214",  "1774795214",  "1774795214",  null]
        ]];

        fp.ViewModel = function() {
            var self = this;

            self.sceneIndex = ko.observable(0);

            self.moveNext = function () {

                var index = self.sceneIndex() + 1;
                if (index >= fp.prmf.length) index = 0;

                self.sceneIndex(index);
            };

            self.risk = {
                riskModel: new fp.RiskModel({ chartWrapper: new irisHighChartWrapper(), hideCollapsibleFunction: hideAllCollapsibles, showDataFunction: modalRiskChartData })
            };

            self.flightPlan = {
                flightPlanModel: new fp.FlightPlanModel({ chartWrapper: new irisHighChartWrapper(), hideCollapsibleFunction: hideAllCollapsibles })
            };

            self.sceneChange = ko.computed(function () {
                if (self.risk.riskModel && fp.riskData[self.sceneIndex()] != undefined) self.risk.riskModel.chartData(fp.riskData[self.sceneIndex()]);
                if (self.flightPlan.flightPlanModel && fp.flightPlanData[self.sceneIndex()] != undefined) self.flightPlan.flightPlanModel.chartData(fp.flightPlanData[self.sceneIndex()]);
            }, this);

            self.assetAlloccationChanged = function() {
                var uiAA = {
                    equities: self.controlPanel.controlPanelModel.equities(),
                    gilts: self.controlPanel.controlPanelModel.gilts(),
                    swaps: self.controlPanel.controlPanelModel.swaps(),
                    volControlledEquities: self.controlPanel.controlPanelModel.volControlledEquities()
                }

                //underscore doesn't do a deep compare in indexOf, so interation
                for (i = 0; i < fp.controlPanelData.length; i++) {
                    if (_.isEqual(fp.controlPanelData[i], uiAA)){
                        self.sceneIndex(i);
                    }
                }
            };

            self.controlPanel = {
               controlPanelModel: new fp.ControlPanelModel({
                   startingEquities: fp.controlPanelData[0].equities,
                   startingGilts: fp.controlPanelData[0].gilts,
                   startingSwaps: fp.controlPanelData[0].swaps,
                   startingVolControlledEquities: fp.controlPanelData[0].volControlledEquities,
                   assetAllocationChangedCallback: self.assetAlloccationChanged
               })
            };
            /*self.controlPanel = ko.computed(function() {
                return fp.controlPanelData[self.sceneIndex()];
            });*/


            self.prmf = ko.computed(function(){
                return fp.prmf[self.sceneIndex()];
            }, this);

            self.reset = function(){
                if (confirm("Reset to original state?")) {
                    self.controlPanel.controlPanelModel.reset();
                    self.risk.riskModel.reset();
                    self.sceneIndex(0);
                }
            };
        };

        var vm = new fp.ViewModel();

        window.addEventListener('shake', vm.reset, false);

        ko.applyBindings(vm);

    </script>

</body>
</html>

